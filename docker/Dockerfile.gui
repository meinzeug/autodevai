# AutoDev GUI Container - React Frontend with Local Tool Access
FROM node:20-bullseye

# Install system dependencies for GUI applications
RUN apt-get update && apt-get install -y \
    # X11 and GUI support
    x11-apps \
    xauth \
    xvfb \
    # Development tools
    git \
    curl \
    wget \
    vim \
    # Build tools
    build-essential \
    python3 \
    python3-pip \
    # Browser support
    chromium \
    firefox-esr \
    # System utilities
    htop \
    tree \
    jq \
    # Network tools
    netcat \
    telnet \
    iputils-ping \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production && npm cache clean --force

# Create non-root user for security
RUN groupadd -r autodev && useradd -r -g autodev -s /bin/bash autodev
RUN mkdir -p /home/autodev && chown -R autodev:autodev /home/autodev
RUN chown -R autodev:autodev /app

# Security hardening: remove unnecessary packages and clean up
RUN apt-get remove -y wget vim nano && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/* /tmp/* /var/tmp/*

# Copy application source
COPY --chown=autodev:autodev . .

# Build the React application
RUN npm run build

# Install only essential production tools
RUN npm install -g \
    @claudejs/claude-code \
    serve && \
    # Remove npm cache and temporary files for security
    npm cache clean --force && \
    rm -rf /tmp/* /root/.npm

# Setup secure environment
ENV NODE_ENV=production
ENV PORT=3000
ENV DISPLAY=:0
ENV REACT_APP_API_URL=http://localhost:50052
# Security environment variables
ENV NODE_OPTIONS="--max-old-space-size=512"
ENV NPM_CONFIG_AUDIT=false
ENV NPM_CONFIG_FUND=false

# Create startup script
RUN cat > /app/start-gui.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting AutoDev GUI Container..."

# Setup X11 forwarding
if [ -n "$DISPLAY" ]; then
    echo "ğŸ“º Setting up X11 display: $DISPLAY"
    xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | xauth -f /tmp/.X11-auth add -
    export XAUTHORITY=/tmp/.X11-auth
fi

# Start the React development server in background
echo "ğŸ”§ Starting React development server..."
npm start &

# Start the production build server
echo "ğŸŒ Starting production server on port 3000..."
npx serve -s build -l 3000 &

# Keep container running and show logs
echo "âœ… AutoDev GUI started successfully!"
echo "ğŸŒ Web interface: http://localhost:50080"
echo "ğŸ”§ Dev server: http://localhost:50081"
echo "ğŸ“± React app ready!"

# Wait for any process to exit
wait -n

# Exit with status of process that exited first
exit $?
EOF

RUN chmod +x /app/start-gui.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# Switch to non-root user
USER autodev

# Expose ports
EXPOSE 3000 3001

# Start the application
CMD ["/app/start-gui.sh"]